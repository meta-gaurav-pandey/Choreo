<?xml version="1.0" encoding="UTF-8"?>
<sequence name="ChildDataSequenec" onError="ErrorSequence" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log>
        <property name="childDataSequenec" value="Started"/>
    </log>
    <msazurestorage.init>
        <accountName>zeniastorage</accountName>
        <accountKey>bPwp6wLgmSIglDQpIopUn4CUs1MPdfMNawYjw4JAgYO6gXi+kBLXApGOlb+bPQYMUsXruE0dWLOU+AStbA1Rdw==</accountKey>
    </msazurestorage.init>
    <filter regex=".+" source="get-property('query.param.child_file')">
        <then>
            <msazurestorage.downloadBlob>
                <containerName>{get-property('query.param.containerName')}</containerName>
                <fileName>{get-property('query.param.child_file')}</fileName>
            </msazurestorage.downloadBlob>
            <property expression="get-property('query.param.child_file')" name="childfileName" scope="default" type="STRING"/>
            <property expression="fn:concat($ctx:DownloadPath,'/',$ctx:childfileName)" name="childfilePath" scope="default" type="STRING"/>
            <file.checkExist configKey="FILE_CONNECTION_1">
                <path>{$ctx:childfilePath}</path>
                <includeResultTo>Message Body</includeResultTo>
            </file.checkExist>
            <property expression="json-eval($.checkExistResult.fileExists)" name="response" scope="default" type="STRING"/>
            <switch source="get-property('response')">
                <case regex="true">
                    <file.read configKey="FILE_CONNECTION_1">
                        <path>{$ctx:childfilePath}</path>
                        <readMode>Complete File</readMode>
                        <startLineNum>0</startLineNum>
                        <lineNum>0</lineNum>
                        <contentType>text/plain</contentType>
                        <includeResultTo>Message Body</includeResultTo>
                        <enableStreaming>false</enableStreaming>
                        <enableLock>false</enableLock>
                    </file.read>
                    <log>
                        <property name="File Connector" value="Read the csv file and converting into json format"/>
                    </log>
                    <CSV.csvToJson>
                        <headerPresent>Present</headerPresent>
                        <valueSeparator>,</valueSeparator>
                        <skipHeader>true</skipHeader>
                        <csvEmptyValues>Empty</csvEmptyValues>
                    </CSV.csvToJson>
                    <switch source="$ctx:source">
                        <case regex="linkedin">
                            <class name="com.example.LinkedInMapper"/>
                        </case>
                        <case regex="dbpedia">
                            <class name="com.example.DBPediaMapper"/>
                        </case>
                        <case regex="yahoo">
                            <class name="com.example.YahooMapper"/>
                        </case>
                        <default>
                            <class name="com.example.ZoomInfoClass"/>
                        </default>
                    </switch>
                    <sequence key="InsertionSequence"/>
                </case>
                <default>
                    <log separator=",">
                        <property name="Default log" value="No file exist"/>
                    </log>
                    <payloadFactory media-type="text">
                        <format>No file exist at the location under desired location for child </format>
                        <args/>
                    </payloadFactory>
                </default>
            </switch>
        </then>
        <else>
            <payloadFactory media-type="text">
                <format>The child file name is not present please enter a valid file name along with foder name.</format>
                <args/>
            </payloadFactory>
        </else>
    </filter>
    <log>
        <property name="childDataSequence" value="sequence completed"/>
    </log>
    <property expression="$body" name="payload1" scope="default" type="STRING"/>
</sequence>
